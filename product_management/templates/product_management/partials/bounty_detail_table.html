{% if bounty_data %}
<div class="relative overflow-x-auto">
    <table class="w-full text-sm text-left text-gray-500">
        <thead class="text-xs text-gray-700 uppercase bg-gray-50">
            <tr>
                <th scope="col" class="px-2 py-3">
                    Bounty
                </th>
                <th scope="col" class="px-2 py-3">
                    Skill
                </th>
                <th scope="col" class="px-2 py-3">
                    Expertise
                </th>

                <th scope="col" class="px-2 py-3">
                    Points
                </th>
                <th scope="col" class="px-2 py-3">
                    Status
                </th>
                <th scope="col" class="px-2 py-3">
                    Assignee
                </th>
                <th scope="col" class="px-2 py-3">
                    Actions
                </th>
            </tr>
        </thead>
        <tbody>
            {% for elem in bounty_data %}
            {% set bounty = elem.bounty %}
            <tr class="bg-white border-b">
                <td class="relative whitespace-normal py-4 pl-3 pr-4 text-sm font-medium sm:pr-0">
                    <a href="{{ url('bounty-detail', args=(challenge.product.slug, challenge.id, bounty.id,)) }}"
                        class="text-indigo-600 hover:text-indigo-900">{{ bounty.title }}</a>
                </td>
                <th scope="row" class="px-2 py-1 font-medium text-gray-900 whitespace-nowrap">
                    {{ bounty.skill }}
                </th>
                <td class="px-2 py-1">
                    {{ bounty.get_expertise_as_str() }}
                </td>
                <td class="px-2 py-1">
                    {{ bounty.points }}
                </td>
                <td class="px-2 py-1">
                    {{ elem.status }}
                </td>
                <td class="px-2 py-1">

                    {% set claimed_by = elem.claimed_by %}

                    {% if elem.can_be_claimed %}
                    No one Assigned
                    {% elif claimed_by %}
                    <div class="flex items-center text-xs text-black/[0.85]">
                        <a href="{{ claimed_by.get_absolute_url() }}" class="flex items-center ml-4">
                            <div class="flex items-center justify-center shrink-0 w-8 h-8 mr-1.5">
                                <img class="w-full h-full rounded-full bg-gray-50 ring-2 ring-white"
                                    src="{{ claimed_by.get_photo_url() }}" alt="Created By">
                            </div>
                            <div class="text-neutral-800">
                                {{ claimed_by.get_full_name() }}
                            </div>
                        </a>
                    </div>
                    {% endif %}
                    <p>
                    </p>
                </td>
                <td class="relative whitespace-nowrap">
                    {% if elem.show_actions %}
                    {% if elem.can_be_claimed %}
                    {% with bounty=elem.bounty %}
                    {% include 'product_management/partials/buttons/create_bounty_claim_button.html' %}
                    {% endwith %}
                    {% endif %}
                    {% if elem.can_be_modified %}
                    <a href="{{ url('update-bounty', args=(challenge.product.slug, challenge.id, bounty.id,)) }}"
                        class="text-blue-700 hover:text-white border border-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-1 text-center me-2 dark:border-blue-500 dark:text-blue-500 dark:hover:text-white dark:hover:bg-blue-600 dark:focus:ring-blue-900 mr-1">Edit</a>

                    <a hx-get="{{ url('delete-bounty', args=(challenge.product.slug, challenge.id, bounty.id,)) }}"
                        hx-confirm="Are you sure to delete this bounty?" hx-target="body" hx-swap="innerHTML"
                        hx-push-url="true"
                        class="text-red-700 cursor-pointer hover:text-white border border-red-700 hover:bg-red-800 focus:ring-4 focus:outline-none focus:ring-red-300 font-medium rounded-lg text-sm px-4 py-1 text-center me-2 mb-2 dark:border-red-500 dark:text-red-500 dark:hover:text-white dark:hover:bg-red-600 dark:focus:ring-red-900 mr-1">Delete
                    </a>
                    {% endif %}

                    {% if elem.created_bounty_claim_request %}
                    {% with bounty_claim=elem.bounty_claim %}
                    {% include 'product_management/partials/buttons/delete_bounty_claim_button.html' %}
                    {% endwith %}
                    {% endif %}

                    {% else %}
                    <p>No action is available for this bounty.</p>
                    {% endif %}

                </td>

            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
</div>

{% if does_have_permission %}
<p>
    <a class="inline-block" href=" {{ url('create-bounty', args=(challenge.product.slug, challenge.pk,)) }}">
        <button class="p-4 rounded-md bg-indigo-600 mt-4 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500"
            type="button">
            Create another bounty for this challenge</button>
    </a>
</p>
{% endif %}

{% else %}
<p class="text-sm italic text-red-600">This challenge has no bounty associated with it.</p>

{% if does_have_permission %}
<p>
    <a class="inline-block" href=" {{ url('create-bounty', args=(challenge.product.slug, challenge.pk,)) }}">
        <button class="p-4 rounded-md bg-indigo-600 mt-4 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500"
            type="button">
            Create a bounty for this</button>
    </a>
</p>
{% endif %}

{% endif %}

<script>
    document.addEventListener('htmx:confirm', function (event) {
        if (event.detail.elt.getAttribute('claim-bounty')) {
            event.preventDefault()
            $.confirm({
                title: 'Bounty Claim',
                typeAnimated: true,
                boxWidth: '350px',
                useBootstrap: false,
                onOpenBefore: function () {
                    this.$content.find('#expected_submission_date')[0].valueAsDate = new Date();
                },
                content: `
            <hr><br>
            <form class="w-full max-w-sm confirm-form" >
                <div class="w-full px-3">
                  <label class="block uppercase tracking-wide text-gray-700 text-xs font-bold mb-2" for="expected_submission_date">
                    Expected Submission Date
                  </label>
                  <input class="appearance-none block w-full bg-gray-200 text-gray-700 border border-gray-200 rounded py-3 px-4 leading-tight focus:outline-none focus:bg-white focus:border-gray-500" id="expected_submission_date" type="date" placeholder="DD/MM/YY" required>
                </div>

                <div class="w-full px-3">
                  <input id="term_checkbox" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-100 border-gray-300 rounded focus:ring-blue-500 dark:focus:ring-blue-600  focus:ring-2" required>
                  <label for="term_checkbox" class="ms-2 text-sm font-medium text-gray-900 dark:text-gray-300">I accept the <a href="{{ url('terms-of-use') }}" target="_blank" class="text-blue-600 dark:text-blue-500 hover:underline">terms and conditions</a>.</label>
                </div>

              </form>
            `,
                buttons: {
                    formSubmit: {
                        text: 'Request claim',
                        btnClass: 'btn-blue',
                        useBootstrap: false,
                        action: function () {
                            const inputField = document.getElementById("expected_submission_date");
                            const checkbox = document.getElementById("term_checkbox");

                            const form = document.querySelector('.confirm-form');
                            if (!form.checkValidity()) {
                                const formControls = form.querySelectorAll('input');
                                formControls.forEach(function (control) {
                                    if (!control.checkValidity()) {
                                        control.reportValidity();
                                    }
                                });
                                return false;
                            } else {
                                const data = {
                                    are_terms_accepted: true,
                                    expected_finish_date: inputField.value,
                                };
                                event.target.setAttribute("hx-vals", JSON.stringify(data));

                                event.detail.issueRequest()
                                this.close();
                            }

                        },

                    },
                    cancel: function () {
                        this.close();
                    },
                },
            });
        }
    })

    // document.addEventListener('htmx:afterRequest', function(event) {
    //     if (event.detail.xhr.responseURL.indexOf('bounty-claim') !== -1) {
    //         var response = JSON.parse(event.detail.xhr.responseText);
    //         if (event.detail.xhr.status === 200) {
    //             const  tdTag = event.target.closest("td")
    //             event.target.classList.add("hidden")
    //             const visibleButtonCount = tdTag.querySelectorAll('a:not([class*="hidden"]').length;
    //             if (visibleButtonCount == 0) {
    //                 tdTag.innerHTML = "No action is available for this bounty.";
    //                 tdTag.classList.remove("hidden")
    //             }
    //         } 
    //     }
    // });
</script>
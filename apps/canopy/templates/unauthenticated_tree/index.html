{% extends 'base.html' %}
{% import "unauthenticated_tree/helper/tree_macros.html" as tree_macros %}

{% block content %}

<div class="flex justify-center">
    <div id="product_tree" class="w-full sm:w-full md:w-3/5 flex flex-col">
        <form id="shareable_product_tree" class="hidden" hx-post="{{url('canopy:update_product_tree',args=(product_tree.pk,) )}}" hx-swap="none">
            <div class="flex">
                <div class="relative w-3/5">
                    <input type="text" name="name"  value="{{product_tree.name}}" class="block p-2.5 w-full z-20 py-1.5 px-3 h-9 p-3  text-gray-900 bg-gray-50 rounded-e-lg rounded-s-gray-100 rounded-s-2 border border-gray-300 focus:ring-indigo-500 focus:border-indigo-500" placeholder="Name ..." required />
                    <button type="submit" class="absolute top-0 end-0 px-2.5 h-full text-sm font-medium text-white bg-indigo-700 rounded-e-lg border border-indigo-700 bg-white">
                        <i class="fa fa-check-circle text-indigo-500" aria-hidden="true"></i>
                    </button>
                </div>
            </div>
            <p class="text-red-500" id="shareable_product_tree_error"> </p>
        </form>

        <h3 class="text-xl font-bold mb-3 text-black mb-2" id="shareable_product_tree_name">
            <span id="shareable_product_name"> {{product_tree.name}} </span>
            <button class="ml-2" onclick="editTreeName(event)"><i class="fa-solid fa-pen-to-square text-indigo-500"></i></button>
        </h3>

        <div class="flex justify-between w-full mb-2 mt-2">
            {% include "unauthenticated_tree/helper/add_product_area_button.html" %}
            {% include "unauthenticated_tree/helper/tooltip.html" %}
        </div>
        <ul ondrop="drop(event)" class="pl-0" id="">
            {{ tree_macros.generate_product_area_tree(tree_data, can_modify_product) }}
        </ul>

        <!-- Container to hold the new form -->
        <div id="form_container" class="w-full"></div>
    </div>
</div>



<script>
    document.addEventListener("htmx:afterRequest", function(event) {
        if (event.target.id=="shareable_product_tree"){
            if (event.detail.successful){
                document.getElementById("shareable_product_tree").classList.add("hidden")
                console.log(JSON.parse(event.detail.xhr.response).name)
                document.getElementById("shareable_product_name").innerHTML = JSON.parse(event.detail.xhr.response).name
                document.getElementById("shareable_product_tree_name").classList.remove("hidden")
            }
            else{
                document.getElementById("shareable_product_tree_error").innerHTML = JSON.parse(event.detail.xhr.response).error
            }
        }
    });

    function editTreeName(event){
        document.getElementById('shareable_product_tree').classList.remove('hidden')
        document.getElementById('shareable_product_tree_name').classList.add('hidden')
    }
    function copyReferralLink() {
        const copyText = document.getElementById("sharable_link");
        navigator.clipboard.writeText(copyText.value);
        var tooltip = document.getElementById("myTooltip");
        tooltip.innerHTML = "Copied!";
    }

    function toggleVisibility(event) {
        event.preventDefault()
        const targetElement = event.target.closest("li");
        const ul = targetElement.querySelector("ul");
        const icon = targetElement.querySelector(".icon-arrow");
        if (icon.getAttribute("data-icon")=="circle-chevron-down"){
            icon.setAttribute("data-icon","circle-chevron-right");
            ul.classList.add("hidden");
        }
        else{
            icon.setAttribute("data-icon","circle-chevron-down");
            ul.classList.remove("hidden");
        }
    }

    function drop(event) {
        var data = event.dataTransfer.getData("text");
        var draggedElement = document.getElementById(data)
        var targetElement = event.target.closest("li")
        var existingUl = targetElement.querySelector("ul");
        var parentUl = targetElement.closest("ul");

        var parentClass = parentUl.className;

        var currentMarginLeft = parseInt(parentClass.match(/pl-([0-9]+)/)[1])
        var childMargin = currentMarginLeft + 4
        var childClass = parentClass.replace(/pl-[0-9]+/, "pl-" + childMargin);

        if (!existingUl) {
            existingUl = document.createElement("ul");
            existingUl.className = childClass;
            targetElement.appendChild(existingUl);
        }
        existingUl.appendChild(draggedElement);

        const targetId = draggedElement.getAttribute("data-id")
        const parentId = targetElement.getAttribute("data-id")

        document.getElementById(`drop_parent_${targetId}`).value = parentId
        document.getElementById(`drop_submit_${targetId}`).click()
        event.stopPropagation();
    }

    function allowDrop(event) {
        event.preventDefault();
    }

    function drag(event) {
        event.dataTransfer.setData("text", event.target.id);
    }

    var searchEmptyElement = document.querySelector(".search_empty");
    var treeContainer = document.getElementById("product_tree");
    var treeNodes = treeContainer.querySelectorAll("li");

</script>
{% endblock content %}

{% extends "challenge_authoring/base.html" %}
{% load static %}

{% block title %}Create Challenge{% endblock %}

{% block content %}
<div class="min-h-screen flex flex-col">
    <!-- Main content -->
    <div class="flex-grow bg-white rounded-lg border p-6">
        <h1 class="text-xl font-semibold mb-6">Create Challenge</h1>
        
        <div class="error-container hidden"></div>
        
        <form id="challenge-form" 
              method="post" 
              enctype="multipart/form-data"
              onsubmit="return false;"
              data-product-slug="{{ product.slug }}"
              action="{% url 'challenge_authoring:create' product.slug %}">
            {% csrf_token %}
            
            <!-- Title -->
            <div class="form-control">
                <label class="label">
                    <span class="label-text text-sm font-medium">Title</span>
                </label>
                <input type="text" 
                       id="title-input"
                       name="title" 
                       class="input input-bordered w-full" 
                       placeholder="Enter challenge title"
                       value="{{ form.title.value|default:'' }}"
                       maxlength="{{ form.title.field.max_length }}">
                {% if form.title.errors %}
                    <div class="text-error text-sm mt-1">
                        {{ form.title.errors|join:", " }}
                    </div>
                {% endif %}
            </div>

            <!-- Description -->
            <div class="form-control mt-6">
                <label class="label">
                    <span class="label-text text-sm font-medium">Description <span class="text-red-500">*</span></span>
                </label>
                <div class="editor-container">
                    <input type="hidden" name="description" id="description">
                    <div id="editor"></div>
                </div>
            </div>

            <!-- Bounties Section -->
            <div class="form-control mt-6">
                <label class="label">
                    <span class="label-text text-sm font-medium">Bounties</span>
                </label>
                <button type="button" class="btn btn-outline btn-primary" id="add-bounty-btn">
                    <i class="fas fa-plus"></i>
                    Add Bounty
                </button>
                <div id="bounties-container" class="mt-4 space-y-4"></div>
            </div>

            <!-- Priority -->
            <div class="form-control mt-6">
                <label class="label">
                    <span class="label-text text-sm font-medium">Priority</span>
                </label>
                <select id="priority-select" name="priority" class="select select-bordered w-full">
                    {% for value, label in form.fields.priority.choices %}
                        <option value="{{ value }}" {% if form.priority.value == value %}selected{% endif %}>
                            {{ label }}
                        </option>
                    {% endfor %}
                </select>
                {% if form.priority.errors %}
                    <div class="text-error text-sm mt-1">
                        {{ form.priority.errors|join:", " }}
                    </div>
                {% endif %}
            </div>

            <!-- File Upload Section -->
            <div class="form-control mt-6">
                <label class="label">
                    <span class="label-text text-sm font-medium">Attachments</span>
                </label>
                <div class="file-upload-area" id="file-upload-area">
                    <div class="text-center">
                        <i class="fas fa-upload mb-2" style="font-size: 24px;"></i>
                        <p class="text-sm text-base-content/70">
                            Drag and drop files here or
                            <label class="text-primary cursor-pointer">
                                browse
                                <input type="file" multiple class="hidden" id="file-input">
                            </label>
                        </p>
                        <p class="text-xs text-base-content/50 mt-1">Maximum file size: 10MB</p>
                    </div>
                </div>
                <div id="file-list" class="mt-4 space-y-2"></div>
            </div>

            <!-- Attachments formset -->
            {{ attachment_formset.management_form }}
            {% for form in attachment_formset %}
                {{ form.id }}
                <div class="form-control">
                    {{ form.file }}
                    {% if form.file.errors %}
                        <div class="text-error text-sm mt-1">
                            {{ form.file.errors|join:", " }}
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        </form>
    </div>

    <!-- Fixed bottom bar -->
    <div class="sticky bottom-0 bg-white border-t px-6 py-4 flex justify-between items-center mt-6">
        <button class="btn btn-ghost btn-sm gap-2" type="button" id="cancel-btn">
            <i class="fas fa-times"></i>
            Cancel
        </button>
        <button class="btn btn-primary btn-sm gap-2" type="submit" form="challenge-form">
            <i class="fas fa-check"></i>
            SAVE
        </button>
    </div>
</div>

<!-- Add this debug output -->
<div style="display:none">
    DEBUG - Bounty Form Available: {{ bounty_form|yesno:"yes,no" }}
    {% if bounty_form %}
        Skills Count: {{ bounty_form.skill.field.queryset.count }}
    {% endif %}
</div>

{% include "challenge_authoring/components/bounty_modal.html" %}
{% endblock %}

{% block page_scripts %}
<!-- First, initialize the product slug -->
<script>
    window.PRODUCT_SLUG = "{{ product.slug }}";  // Using product.slug instead of product_slug
    console.log('Setting PRODUCT_SLUG:', window.PRODUCT_SLUG);
</script>

<!-- Keep your existing DOMContentLoaded script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Focus title input on page load
    const titleInput = document.getElementById('title-input');
    if (titleInput) {
        titleInput.focus();
    }

    // Add bounty button click handler - Add this before other initializations
    console.log('Setting up bounty button handler');
    const addBountyBtn = document.getElementById('add-bounty-btn');
    if (addBountyBtn) {
        console.log('Found bounty button');
        addBountyBtn.addEventListener('click', () => {
            console.log('Add Bounty button clicked!');
            showModal();
        });
    } else {
        console.warn('Bounty button not found');
    }

    // Initialize Choices.js selects
    const prioritySelect = new Choices('#priority-select', {
        searchEnabled: false,
        itemSelectText: '',
        removeItemButton: false,
        allowHTML: true
    });

    // Initialize Quill
    if (window.Quill) {
        const quill = new Quill('#editor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ 'header': [1, 2, 3, false] }],
                    ['bold', 'italic', 'underline'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['link']
                ]
            },
            placeholder: 'Enter description...'
        });

        // Update hidden input whenever Quill content changes
        quill.on('text-change', function() {
            const descriptionInput = document.getElementById('description');
            descriptionInput.value = quill.root.innerHTML;
        });

        // Also update on form submit
        const form = document.getElementById('challenge-form');
        if (form) {
            form.addEventListener('submit', function() {
                const descriptionInput = document.getElementById('description');
                descriptionInput.value = quill.root.innerHTML;
            });
        }
    }

    // Add modal functions
    window.showModal = function() {
        // Reset form fields
        const skillSelect = document.getElementById('bounty-skill');
        const titleInput = document.getElementById('bounty-title');
        const pointsInput = document.getElementById('bounty-points');
        
        // Reset skill dropdown to first option
        if (skillSelect) {
            skillSelect.value = '';
        }
        
        // Reset title and points
        if (titleInput) {
            titleInput.value = '';
        }
        if (pointsInput) {
            pointsInput.value = '';
        }
        
        // Reset Quill editor content if it exists
        const editor = document.querySelector('#bounty-description-editor .ql-editor');
        if (editor) {
            editor.innerHTML = '';
        }

        // Show modal
        document.getElementById('bounty-modal').classList.add('modal-open');
    }

    window.hideModal = function() {
        document.getElementById('bounty-modal').classList.remove('modal-open');
    }

    window.saveBounty = function() {
        // Add your bounty saving logic here
        console.log('Saving bounty...');
    }
});
</script>

<!-- Keep your module script last -->
<script type="module" src="{% static 'challenge_authoring/js/index.js' %}"></script>
{% endblock %}

{% import "product_management/tree_helper/product_tree_macros.html" as tree_macros %}

<div class="flex flex-col flex-grow nested">
    {% include "product_management/tree_helper/search_empty.html" %}

    <div class="mt-4 lg:mt-6">
      <div id="product_tree"
        class="tree-demo flex flex-col gap-4 tree_container overflow-x-auto sm:overflow-x-hidden overflow-y-hidden">
          <ul ondrop="drop(event)" class="pl-0">
              {{ tree_macros.generate_product_area_tree(tree_data, product_slug, can_modify_product) }}
        </ul>
      </div>
    </div>
  </div>

  <script>
    function toggleVisibility(event) {
        event.preventDefault()
        const targetElement = event.target.closest("li");
        const ul = targetElement.querySelector("ul");
        const icon = targetElement.querySelector(".icon-arrow");
        if (icon.getAttribute("data-icon")=="circle-chevron-down"){
            icon.setAttribute("data-icon","circle-chevron-right");
        }
        else{
            icon.setAttribute("data-icon","circle-chevron-down");
        }
        if (ul) {
            ul.classList.toggle("hidden");
        }
    }

    function drop(event) {
        var data = event.dataTransfer.getData("text");
        var draggedElement = document.getElementById(data)
        var targetElement = event.target.closest("li")
        var existingUl = targetElement.querySelector("ul");
        var parentUl = targetElement.closest("ul");

        var parentClass = parentUl.className;

        var currentMarginLeft = parseInt(parentClass.match(/pl-([0-9]+)/)[1])
        var childMargin = currentMarginLeft + 4
        var childClass = parentClass.replace(/pl-[0-9]+/, "pl-" + childMargin);

        if (!existingUl) {
            existingUl = document.createElement("ul");
            existingUl.className = childClass;
            targetElement.appendChild(existingUl);
        }
        existingUl.appendChild(draggedElement);

        const targetId = draggedElement.getAttribute("data-id")
        const parentId = targetElement.getAttribute("data-id")

        document.getElementById(`drop_parent_${targetId}`).value = parentId
        document.getElementById(`drop_submit_${targetId}`).click()
        event.stopPropagation();
    }

    function allowDrop(event) {
        event.preventDefault();
    }

    function drag(event) {
        event.dataTransfer.setData("text", event.target.id);
    }

    var treeContainer = document.getElementById("product_tree");
    var treeNodes = treeContainer.querySelectorAll("li");
</script>
